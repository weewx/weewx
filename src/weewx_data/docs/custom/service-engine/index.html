
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Tom Keffer <tkeffer@gmail.com>">
      
      
        <link rel="canonical" href="https://www.weewx.com/custom/service-engine/">
      
      
        <link rel="prev" href="../sle/">
      
      
        <link rel="next" href="../derived/">
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.14">
    
    
      
        <title>Services - WeeWX 5.0</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.85bb2934.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a6bdf11c.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:300,300i,400,400i,700,700i%7CInconsolata+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Noto Sans";--md-code-font:"Inconsolata Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/weewx_ui.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="white">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#customizing-the-service-engine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="WeeWX 5.0" class="md-header__button md-logo" aria-label="WeeWX 5.0" data-md-component="logo">
      
  <img src="../../images/logo-weewx.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WeeWX 5.0
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Services
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="WeeWX 5.0" class="md-nav__button md-logo" aria-label="WeeWX 5.0" data-md-component="logo">
      
  <img src="../../images/logo-weewx.png" alt="logo">

    </a>
    WeeWX 5.0
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Quick start
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Quick start
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstarts/debian/" class="md-nav__link">
        Debian
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstarts/redhat/" class="md-nav__link">
        RedHat
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstarts/suse/" class="md-nav__link">
        SuSE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstarts/pip/" class="md-nav__link">
        pip
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstarts/git/" class="md-nav__link">
        git
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          User's guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          User's guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/installing/" class="md-nav__link">
        Installing WeeWX
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/where/" class="md-nav__link">
        Where to find things
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/running/" class="md-nav__link">
        Running WeeWX
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/webserver/" class="md-nav__link">
        Web server integration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/backup/" class="md-nav__link">
        Backup & restore
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/mysql-mariadb/" class="md-nav__link">
        MySQL/MariaDB
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_8" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
          Troubleshooting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          Troubleshooting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/troubleshooting/what-to-do/" class="md-nav__link">
        What to do
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/troubleshooting/hardware/" class="md-nav__link">
        Hardware problems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/troubleshooting/software/" class="md-nav__link">
        Software problems
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../usersguide/troubleshooting/meteo/" class="md-nav__link">
        Meteorological problems
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Customization guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Customization guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../custom-reports/" class="md-nav__link">
        Customizing reports
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../report-scheduling/" class="md-nav__link">
        Scheduling reports
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cheetah-generator/" class="md-nav__link">
        The Cheetah generator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../image-generator/" class="md-nav__link">
        The Image generator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../localization/" class="md-nav__link">
        Localization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../database/" class="md-nav__link">
        Customizing the database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../units/" class="md-nav__link">
        Customizing units
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../multiple-bindings/" class="md-nav__link">
        Multiple data bindings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sle/" class="md-nav__link">
        Search lists
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Services
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modify-service" class="md-nav__link">
    Modifying an existing service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service" class="md-nav__link">
    Creating a new service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-data-source" class="md-nav__link">
    Adding a second data source
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../derived/" class="md-nav__link">
        Derived types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../drivers/" class="md-nav__link">
        Drivers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extensions/" class="md-nav__link">
        Extensions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Utilities guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Utilities guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weewxd/" class="md-nav__link">
        weewxd
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
          weectl
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5_2">
          <span class="md-nav__icon md-icon"></span>
          weectl
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-about/" class="md-nav__link">
        weectl
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-database/" class="md-nav__link">
        weectl database
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-debug/" class="md-nav__link">
        weectl debug
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-device/" class="md-nav__link">
        weectl device
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-extension/" class="md-nav__link">
        weectl extension
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/weectl-station/" class="md-nav__link">
        weectl station
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/wee_import/" class="md-nav__link">
        wee_import
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../utilities/wee_reports/" class="md-nav__link">
        wee_reports
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          Hardware guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Hardware guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/drivers/" class="md-nav__link">
        Drivers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/acurite/" class="md-nav__link">
        AcuRite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/cc3000/" class="md-nav__link">
        CC3000
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/fousb/" class="md-nav__link">
        FineOffset
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/te923/" class="md-nav__link">
        TE923
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/ultimeter/" class="md-nav__link">
        Ultimeter
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/vantage/" class="md-nav__link">
        Vantage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/wmr100/" class="md-nav__link">
        WMR100
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/wmr300/" class="md-nav__link">
        WMR300
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/wmr9x8/" class="md-nav__link">
        WMR9x8
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/ws1/" class="md-nav__link">
        WS1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/ws23xx/" class="md-nav__link">
        WS23xx
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/ws28xx/" class="md-nav__link">
        WS28xx
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../upgrade/" class="md-nav__link">
        Upgrade guide
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
          Application options
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_1">
          <span class="md-nav__icon md-icon"></span>
          Application options
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/general/" class="md-nav__link">
        General options
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stations/" class="md-nav__link">
        [Station]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdrestful/" class="md-nav__link">
        [StdRESTful]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdreport/" class="md-nav__link">
        [StdReport]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdconvert/" class="md-nav__link">
        [StdConvert]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdcalibrate/" class="md-nav__link">
        [StdCalibrate]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdqc/" class="md-nav__link">
        [StdQC]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdwxcalculate/" class="md-nav__link">
        [StdWXCalculate]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdarchive/" class="md-nav__link">
        [StdArchive]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/stdtimesynch/" class="md-nav__link">
        [StdTimeSynch]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/data-bindings/" class="md-nav__link">
        [DataBindings]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/databases/" class="md-nav__link">
        [Databases]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/database-types/" class="md-nav__link">
        [DatabaseTypes]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/weewx-options/engine/" class="md-nav__link">
        [Engine]
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
          Skin options
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          Skin options
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/extras/" class="md-nav__link">
        [Extras]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/labels/" class="md-nav__link">
        [Labels]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/almanac/" class="md-nav__link">
        [Almanac]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/units/" class="md-nav__link">
        [Units]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/texts/" class="md-nav__link">
        [Texts]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/cheetahgenerator/" class="md-nav__link">
        [CheetahGenerator]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/imagegenerator/" class="md-nav__link">
        [ImageGenerator]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/copygenerator/" class="md-nav__link">
        [CopyGenerator]
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/skin-options/generators/" class="md-nav__link">
        [Generators]
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/aggtypes/" class="md-nav__link">
        Aggregation types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/durations/" class="md-nav__link">
        Durations
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/units/" class="md-nav__link">
        Units
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/valuetuple/" class="md-nav__link">
        ValueTuple
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/valuehelper/" class="md-nav__link">
        ValueHelper
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../devnotes/" class="md-nav__link">
        Notes for developers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../changes/" class="md-nav__link">
        Change log
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#modify-service" class="md-nav__link">
    Modifying an existing service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service" class="md-nav__link">
    Creating a new service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-data-source" class="md-nav__link">
    Adding a second data source
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="customizing-the-service-engine">Customizing the service engine<a class="headerlink" href="#customizing-the-service-engine" title="Permanent link">&para;</a></h1>
<p>This is an advanced topic intended for those who wish to try their hand
at extending the internal engine in WeeWX. Before attempting these
examples, you should be reasonably proficient with Python.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Please note that the API to the service engine may change in future
versions!</p>
</div>
<p>At a high level, WeeWX consists of an <em>engine</em> that is responsible for
managing a set of <em>services</em>. A service consists of a Python class which
binds its member functions to various <em>events</em>. The engine arranges to
have the bound member function called when a specific event happens,
such as a new LOOP packet arriving.</p>
<p>The services are specified in lists in the
<a href="../../reference/weewx-options/engine/#services"><code>[Engine][[Services]]</code></a>
stanza of the configuration file. The <code>[[Services]]</code> section
lists all the services to be run, broken up into different <em>service
lists</em>.</p>
<p>These lists are designed to orchestrate the data as it flows through the WeeWX
engine. For example, you want to make sure that data has been processed by the
quality control service, <code>StdQC</code>, before putting them in the database.
Similarly, the reporting system must come <em>after</em> the data has been put in the
database. These groups ensure that things happen in the proper sequence.</p>
<p>See the table <a href="../../custom/introduction/#the-weewx-service-architecture">The standard WeeWX services</a>
for a list of the services that are normally run.</p>
<h2 id="modify-service">Modifying an existing service<a class="headerlink" href="#modify-service" title="Permanent link">&para;</a></h2>
<p>The service <code>weewx.engine.StdPrint</code> prints out new LOOP and
archive packets to the console when they arrive. By default, it prints
out the entire record, which generally includes a lot of possibly
distracting information and can be rather messy. Suppose you do not like
this, and want it to print out only the time, barometer reading, and the
outside temperature whenever a new LOOP packet arrives. </p>
<p>This could be done by subclassing the default print service <code>StdPrint</code> and
overriding member function <code>new_loop_packet()</code>.</p>
<p>Create the file <code>user/myprint.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">weewx.engine</span> <span class="kn">import</span> <span class="n">StdPrint</span>
<span class="kn">from</span> <span class="nn">weeutil.weeutil</span> <span class="kn">import</span> <span class="n">timestamp_to_string</span>

<span class="k">class</span> <span class="nc">MyPrint</span><span class="p">(</span><span class="n">StdPrint</span><span class="p">):</span>

    <span class="c1"># Override the default new_loop_packet member function:</span>
    <span class="k">def</span> <span class="nf">new_loop_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">packet</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">packet</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LOOP: &quot;</span><span class="p">,</span> <span class="n">timestamp_to_string</span><span class="p">(</span><span class="n">packet</span><span class="p">[</span><span class="s1">&#39;dateTime&#39;</span><span class="p">]),</span>
            <span class="s2">&quot;BAR=&quot;</span><span class="p">,</span>  <span class="n">packet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;barometer&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">),</span>
            <span class="s2">&quot;TEMP=&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;outTemp&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
</code></pre></div>
<p>This service substitutes a new implementation for the member function
<code>new_loop_packet</code>. This implementation prints out the time, then
the barometer reading (or <code>N/A</code> if it is not available) and the
outside temperature (or <code>N/A</code>).</p>
<p>You then need to specify that your print service class should be loaded
instead of the default <code>StdPrint</code> service. This is done by
substituting your service name for <code>StdPrint</code> in
<code>service_list</code>, located in <code>[Engine]/[[Services]]</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Engine]</span>
<span class="w">    </span><span class="k">[[Services]]</span>
<span class="w">        </span><span class="na">...</span>
<span class="w">        </span><span class="na">report_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">user.myprint.MyPrint, weewx.engine.StdReport</span>
</code></pre></div>
<p>Note that the <code>report_services</code> must be all on one line.
Unfortunately, the parser <code>ConfigObj</code> does not allow options to
be continued on to following lines.</p>
<h2 id="create-service">Creating a new service<a class="headerlink" href="#create-service" title="Permanent link">&para;</a></h2>
<p>Suppose there is no service that can be easily customized for your
needs. In this case, a new one can easily be created by subclassing off
the abstract base class <code>StdService</code>, and then adding the
functionality you need. Here is an example that implements an alarm,
which sends off an email when an arbitrary expression evaluates
<code>True</code>.</p>
<p>This example is included in the standard distribution as
<code>examples/alarm.py:</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  1</span>
<span class="normal">  2</span>
<span class="normal">  3</span>
<span class="normal">  4</span>
<span class="normal">  5</span>
<span class="normal">  6</span>
<span class="normal">  7</span>
<span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">smtplib</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">email.mime.text</span> <span class="kn">import</span> <span class="n">MIMEText</span>

<span class="kn">import</span> <span class="nn">weewx</span>
<span class="kn">from</span> <span class="nn">weeutil.weeutil</span> <span class="kn">import</span> <span class="n">timestamp_to_string</span><span class="p">,</span> <span class="n">option_as_list</span>
<span class="kn">from</span> <span class="nn">weewx.engine</span> <span class="kn">import</span> <span class="n">StdService</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># Inherit from the base class StdService:</span>
<span class="k">class</span> <span class="nc">MyAlarm</span><span class="p">(</span><span class="n">StdService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service that sends email if an arbitrary expression evaluates true&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">):</span>
        <span class="c1"># Pass the initialization information on to my superclass:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>

        <span class="c1"># This will hold the time when the last alarm message went out:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_msg_ts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Dig the needed options out of the configuration dictionary.</span>
            <span class="c1"># If a critical option is missing, an exception will be raised and</span>
            <span class="c1"># the alarm will not be set.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expression</span>    <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">][</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_wait</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_wait&#39;</span><span class="p">,</span> <span class="mi">3600</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>       <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smtp_host</span>     <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">][</span><span class="s1">&#39;smtp_host&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smtp_user</span>     <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smtp_user&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smtp_password</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smtp_password&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SUBJECT</span>       <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> 
                                                          <span class="s2">&quot;Alarm message from weewx&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FROM</span>          <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from&#39;</span><span class="p">,</span>
                                                          <span class="s1">&#39;alarm@example.com&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">TO</span>            <span class="o">=</span> <span class="n">option_as_list</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">][</span><span class="s1">&#39;mailto&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No alarm set.  Missing parameter: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we got this far, it&#39;s ok to start intercepting events:</span>
<span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">weewx</span><span class="o">.</span><span class="n">NEW_ARCHIVE_RECORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_archive_record</span><span class="p">)</span>    <span class="c1"># 1</span>
</span>            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Alarm set for expression: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_archive_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets called on a new archive record event.&quot;&quot;&quot;</span>

        <span class="c1"># To avoid a flood of nearly identical emails, this will do</span>
        <span class="c1"># the check only if we have never sent an email, or if we haven&#39;t</span>
        <span class="c1"># sent one in the last self.time_wait seconds:</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_msg_ts</span> 
                <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_msg_ts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_wait</span><span class="p">):</span>
            <span class="c1"># Get the new archive record:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">record</span>

            <span class="c1"># Be prepared to catch an exception in the case that the expression </span>
            <span class="c1"># contains a variable that is not in the record:</span>
<span class="hll">            <span class="k">try</span><span class="p">:</span>                                                            <span class="c1"># 2</span>
</span>                <span class="c1"># Evaluate the expression in the context of the event archive </span>
                <span class="c1"># record. Sound the alarm if it evaluates true:</span>
<span class="hll">                <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>                     <span class="c1"># 3</span>
</span>                    <span class="c1"># Sound the alarm! Launch in a separate thread,</span>
                    <span class="c1"># so it doesn&#39;t block the main LOOP thread:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">MyAlarm</span><span class="o">.</span><span class="n">sound_the_alarm</span><span class="p">,</span> 
                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">))</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="c1"># Record when the message went out:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">last_msg_ts</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># The record was missing a named variable. Log it.</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sound_the_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sound the alarm in a &#39;try&#39; block&quot;&quot;&quot;</span>

        <span class="c1"># Wrap the attempt in a &#39;try&#39; block so we can log a failure.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_alarm</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
            <span class="c1"># A gaierror exception is usually caused by an unknown host</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Unknown host </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smtp_host</span><span class="p">)</span>
            <span class="c1"># Reraise the exception. This will cause the thread to exit.</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Unable to sound alarm. Reason: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="c1"># Reraise the exception. This will cause the thread to exit.</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">do_alarm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send an email out&quot;&quot;&quot;</span>

        <span class="c1"># Get the time and convert to a string:</span>
        <span class="n">t_str</span> <span class="o">=</span> <span class="n">timestamp_to_string</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;dateTime&#39;</span><span class="p">])</span>

        <span class="c1"># Log the alarm</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Alarm expression &quot;</span><span class="si">%s</span><span class="s1">&quot; evaluated True at </span><span class="si">%s</span><span class="s1">&#39;</span> 
                 <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">t_str</span><span class="p">))</span>

        <span class="c1"># Form the message text:</span>
        <span class="n">msg_text</span> <span class="o">=</span> <span class="s1">&#39;Alarm expression &quot;</span><span class="si">%s</span><span class="s1">&quot; evaluated True at </span><span class="si">%s</span><span class="se">\n</span><span class="s1">Record:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> \
                   <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">t_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
        <span class="c1"># Convert to MIME:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">MIMEText</span><span class="p">(</span><span class="n">msg_text</span><span class="p">)</span>

        <span class="c1"># Fill in MIME headers:</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;Subject&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUBJECT</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FROM</span>
        <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;To&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TO</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># First try end-to-end encryption</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP_SSL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smtp_host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using SMTP_SSL&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Unable to use SMTP_SSL connection. Reason: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="c1"># If that doesn&#39;t work, try creating an insecure host, </span>
            <span class="c1"># then upgrading</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smtp_host</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Be prepared to catch an exception if the server</span>
                <span class="c1"># does not support encrypted transport.</span>
                <span class="n">s</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">starttls</span><span class="p">()</span>
                <span class="n">s</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using SMTP encrypted transport&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Using SMTP unencrypted transport. Reason: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If a username has been given, assume that login is required </span>
            <span class="c1"># for this host:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smtp_user</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">smtp_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smtp_password</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Logged in with user name </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smtp_user</span><span class="p">)</span>

            <span class="c1"># Send the email:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;From&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">TO</span><span class="p">,</span>  <span class="n">msg</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>
            <span class="c1"># Log out of the server:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SMTP mailer refused message with error </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="c1"># Log sending the email:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Email sent to: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">TO</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This section is used to test alarm.py. It uses a record and alarm</span>
<span class="sd">     expression that are guaranteed to trigger an alert.</span>

<span class="sd">     You will need a valid weewx.conf configuration file with an [Alarm]</span>
<span class="sd">     section that has been set up as illustrated at the top of this file.&quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
    <span class="kn">import</span> <span class="nn">weecfg</span>
    <span class="kn">import</span> <span class="nn">weeutil.logger</span>

    <span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Usage: python alarm.py --help    </span>
<span class="s2">       python alarm.py [CONFIG_FILE|--config=CONFIG_FILE]</span>

<span class="s2">Arguments:</span>

<span class="s2">      CONFIG_PATH: Path to weewx.conf &quot;&quot;&quot;</span>

    <span class="n">epilog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;You must be sure the WeeWX modules are in your PYTHONPATH. </span>
<span class="s2">    For example:</span>

<span class="s2">    PYTHONPATH=/home/weewx/bin python alarm.py --help&quot;&quot;&quot;</span>

    <span class="c1"># Force debug:</span>
    <span class="n">weewx</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Create a command line parser:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">epilog</span><span class="o">=</span><span class="n">epilog</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s2">&quot;--config&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;config_path&quot;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;CONFIG_FILE&quot;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use configuration file CONFIG_FILE.&quot;</span><span class="p">)</span>
    <span class="c1"># Parse the arguments and options</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">config_path</span><span class="p">,</span> <span class="n">config_dict</span> <span class="o">=</span> <span class="n">weecfg</span><span class="o">.</span><span class="n">read_config</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config_path</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Unable to open configuration file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using configuration file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># Set logging configuration:</span>
    <span class="n">weeutil</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="s1">&#39;alarm&#39;</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;Alarm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_dict</span><span class="p">:</span>
        <span class="n">exit</span><span class="p">(</span><span class="s2">&quot;No [Alarm] section in the configuration file </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">config_path</span><span class="p">)</span>

    <span class="c1"># This is a fake record that we&#39;ll use</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;extraTemp1&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
           <span class="s1">&#39;outTemp&#39;</span><span class="p">:</span> <span class="mf">38.2</span><span class="p">,</span>
           <span class="s1">&#39;dateTime&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())}</span>

    <span class="c1"># Use an expression that will evaluate to True by our fake record.</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Alarm&#39;</span><span class="p">][</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;outTemp&lt;40.0&quot;</span>

    <span class="c1"># We need the main WeeWX engine in order to bind to the event, </span>
    <span class="c1"># but we don&#39;t need for it to completely start up. So get rid of all</span>
    <span class="c1"># services:</span>
    <span class="n">config_dict</span><span class="p">[</span><span class="s1">&#39;Engine&#39;</span><span class="p">][</span><span class="s1">&#39;Services&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Now we can instantiate our slim engine, using the DummyEngine class...</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">weewx</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">DummyEngine</span><span class="p">(</span><span class="n">config_dict</span><span class="p">)</span>
    <span class="c1"># ... and set the alarm using it.</span>
    <span class="n">alarm</span> <span class="o">=</span> <span class="n">MyAlarm</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>

    <span class="c1"># Create a NEW_ARCHIVE_RECORD event</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">weewx</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">weewx</span><span class="o">.</span><span class="n">NEW_ARCHIVE_RECORD</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">rec</span><span class="p">)</span>

    <span class="c1"># Use it to trigger the alarm:</span>
    <span class="n">alarm</span><span class="o">.</span><span class="n">new_archive_record</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This service expects all the information it needs to be in the configuration
file <code>weewx.conf</code> in a new section called <code>[Alarm]</code>. So, add the following
lines to your configuration file:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Alarm]</span>
<span class="w">    </span><span class="na">expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;outTemp &lt; 40.0&quot;</span>
<span class="w">    </span><span class="na">time_wait</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3600</span>
<span class="w">    </span><span class="na">smtp_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">smtp.example.com</span>
<span class="w">    </span><span class="na">smtp_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">myusername</span>
<span class="w">    </span><span class="na">smtp_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mypassword</span>
<span class="w">    </span><span class="na">mailto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">auser@example.com, anotheruser@example.com</span>
<span class="w">    </span><span class="na">from</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s">me@example.com</span>
<span class="w">    </span><span class="na">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Alarm message from WeeWX!&quot;</span>
</code></pre></div>
<p>There are three important <mark>highlighted</mark> points to be noted in this example.</p>
<ol>
<li>
<p>(Line 45) Here is where the binding happens between an event,
    <code>weewx.NEW_ARCHIVE_RECORD</code>, and a member function, <code>self.new_archive_record</code>.
    When the event <code>NEW_ARCHIVE_RECORD</code> occurs, the function
    <code>self.new_archive_record</code> will be called. There are many other events that can
    be intercepted. Look in the file <code>weewx/_init_.py</code>.</p>
</li>
<li>
<p>(Line 61) Some hardware do not emit all possible observation types in every
    record, so it's possible that a record may be missing some types that are
    used in the expression. This try block will catch the <code>NameError</code> exception
    that would be raised should this occur.</p>
</li>
<li>
<p>(Line 64) This is where the test is done for whether to sound the alarm. The
    <code>[Alarm]</code> configuration options specify that the alarm be sounded when
    <code>outTemp &lt; 40.0</code> evaluates <code>True</code>, that is when the outside temperature is
    below 40.0 degrees. Any valid Python expression can be used, although the
    only variables available are those in the current archive record.</p>
</li>
</ol>
<p>Another example expression could be:</p>
<div class="highlight"><pre><span></span><code><span class="na">expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;outTemp &lt; 32.0 and windSpeed &gt; 10.0&quot;</span>
</code></pre></div>
<p>In this case, the alarm is sounded if the outside temperature drops below
freezing and the wind speed is greater than 10.0.</p>
<p>Note that units must be the same as whatever is being used in your database,
that is, the same as what you specified in option
<a href="../../reference/weewx-options/stdconvert/#target_unit"><code>target_unit</code></a>.</p>
<p>Option <code>time_wait</code> is used to avoid a flood of nearly identical emails. The new
service will wait this long before sending another email out.</p>
<p>Email will be sent through the SMTP host specified by option <code>smtp_host</code>. The
recipient(s) are specified by the comma separated option <code>mailto</code>.</p>
<p>Many SMTP hosts require user login. If this is the case, the user and password
are specified with options <code>smtp_user</code> and <code>smtp_password</code>, respectively.</p>
<p>The last two options, <code>from</code> and <code>subject</code> are optional. If not supplied, WeeWX
will supply something sensible. Note, however, that some mailers require a valid
"from" email address and the one that WeeWX supplies may not satisfy its
requirements.</p>
<p>To make this all work, you must first copy the <code>alarm.py</code> file to the <code>user</code>
directory. Then tell the engine to load this new service by adding the service
name to the list <code>report_services</code>, located in <code>[Engine]/[[Services]]</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">[Engine]</span>
<span class="w">   </span><span class="k">[[Services]]</span>
<span class="w">        </span><span class="na">report_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.engine.StdPrint, weewx.engine.StdReport, user.alarm.MyAlarm</span>
</code></pre></div>
<p>Again, note that the option <code>report_services</code> must be all on one line &mdash;
the <code>ConfigObj</code> parser does not allow options to be continued on to following
lines.</p>
<p>In addition to this example, the distribution also includes a low-battery
alarm (<code>lowBattery.py</code>), which is similar, except that it intercepts LOOP
events instead of archiving events.</p>
<h2 id="add-data-source">Adding a second data source<a class="headerlink" href="#add-data-source" title="Permanent link">&para;</a></h2>
<p>A very common problem is wanting to augment the data from your weather
station with data from some other device. Generally, you have two
approaches for how to handle this:</p>
<ul>
<li>
<p>Run two instances of WeeWX, each using its own database and
    <code>weewx.conf</code> configuration file. The results are then
    combined in a final report, using WeeWX's ability <a href="../../custom/multiple-bindings/">to use more than
    one database</a>. See the Wiki entry
    <a href="https://github.com/weewx/weewx/wiki/weewx-multi"><em>How to run multiple instances of
    WeeWX</em></a> for details
    on how to do this.</p>
</li>
<li>
<p>Run one instance, but use a custom WeeWX service to augment the
    records coming from your weather station with data from the other
    device.</p>
</li>
</ul>
<p>This section covers the latter approach.</p>
<p>Suppose you have installed an electric meter at your house, and you wish
to correlate electrical usage with the weather. The meter has some sort
of connection to your computer, allowing you to download the total power
consumed. At the end of every archive interval you want to calculate the
amount of power consumed during the interval, then add the results to
the record coming off your weather station. How would you do this?</p>
<p>Here is the outline of a service that retrieves the electrical
consumption data and adds it to the archive record. It assumes that you
already have a function <code>download_total_power()</code> that, somehow,
downloads the amount of power consumed since time zero.</p>
<p>File <code>user/electricity.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">weewx</span>
<span class="kn">from</span> <span class="nn">weewx.engine</span> <span class="kn">import</span> <span class="n">StdService</span>

<span class="k">class</span> <span class="nc">AddElectricity</span><span class="p">(</span><span class="n">StdService</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">):</span>

      <span class="c1"># Initialize my superclass first:</span>
      <span class="nb">super</span><span class="p">(</span><span class="n">AddElectricity</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>

      <span class="c1"># Bind to any new archive record events:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">weewx</span><span class="o">.</span><span class="n">NEW_ARCHIVE_RECORD</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_archive_record</span><span class="p">)</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">last_total</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">new_archive_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

        <span class="n">total_power</span> <span class="o">=</span> <span class="n">download_total_power</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_total</span><span class="p">:</span>
            <span class="n">net_consumed</span> <span class="o">=</span> <span class="n">total_power</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_total</span>
            <span class="n">event</span><span class="o">.</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;electricity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_consumed</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_total</span> <span class="o">=</span> <span class="n">total_power</span>
</code></pre></div>
<p>This adds a new key <code>electricity</code> to the record dictionary and
sets it equal to the difference between the amount of power currently
consumed and the amount consumed at the last archive record. Hence, it
will be the amount of power consumed over the archive interval. The unit
should be Watt-hours.</p>
<p>As an aside, it is important that the function
<code>download_total_power()</code> does not delay very long because it will
sit right in the main loop of the WeeWX engine. If it's going to cause
a delay of more than a couple seconds you might want to put it in a
separate thread and feed the results to <code>AddElectricity</code> through
a queue.</p>
<p>To make sure your service gets run, you need to add it to one of the
service lists in <code>weewx.conf</code>, section <code>[Engine]</code>,
subsection <code>[[Services]]</code>.</p>
<p>In our case, the obvious place for our new service is in
<code>data_services</code>. When you're done, your section
<code>[Engine]</code> will look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="c1">#   This section configures the internal WeeWX engine.</span>

<span class="k">[Engine]</span>

<span class="w">    </span><span class="k">[[Services]]</span>
<span class="w">        </span><span class="c1"># This section specifies the services that should be run. They are</span>
<span class="w">        </span><span class="c1"># grouped by type, and the order of services within each group</span>
<span class="w">        </span><span class="c1"># determines the order in which the services will be run.</span>
<span class="w">        </span><span class="na">xtype_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.wxxtypes.StdWXXTypes, weewx.wxxtypes.StdPressureCooker, weewx.wxxtypes.StdRainRater, weewx.wxxtypes.StdDelta</span>
<span class="w">        </span><span class="na">prep_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.engine.StdTimeSynch</span>
<span class="hll"><span class="w">        </span><span class="na">data_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">user.electricity.AddElectricity</span>
</span><span class="w">        </span><span class="na">process_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.engine.StdConvert, weewx.engine.StdCalibrate, weewx.engine.StdQC, weewx.wxservices.StdWXCalculate</span>
<span class="w">        </span><span class="na">archive_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.engine.StdArchive</span>
<span class="w">        </span><span class="na">restful_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.restx.StdStationRegistry, weewx.restx.StdWunderground, weewx.restx.StdPWSweather, weewx.restx.StdCWOP, weewx.restx.StdWOW, weewx.restx.StdAWEKAS</span>
<span class="w">        </span><span class="na">report_services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">weewx.engine.StdPrint, weewx.engine.StdReport</span>
</code></pre></div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright  2009-2023 Thomas Keffer, Matthew Wall, and Gary Roderick, all rights reserved
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.top", "toc.follow", "search.highlight", "search.share", "search.suggest", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>